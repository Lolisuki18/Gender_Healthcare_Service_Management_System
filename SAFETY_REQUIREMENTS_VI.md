## 2.4 An toÃ n (Safety)

2.4.1 Báº£o vá»‡ dá»¯ liá»‡u vÃ  riÃªng tÆ°
SAF-1: Che giáº¥u sá»‘ tháº» tÃ­n dá»¥ng: Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng che giáº¥u sá»‘ tháº» tÃ­n dá»¥ng trong táº¥t cáº£ mÃ n hÃ¬nh hiá»ƒn thá»‹ vÃ  nháº­t kÃ½, chá»‰ hiá»ƒn thá»‹ 4 sá»‘ cuá»‘i (vÃ­ dá»¥: "\***\* \*\*** \*\*\*\* 1234") Ä‘á»ƒ ngÄƒn cháº·n viá»‡c lá»™ thÃ´ng tin tÃ i chÃ­nh. Äiá»u nÃ y sáº½ Ä‘Æ°á»£c xÃ¡c minh thÃ´ng qua kiá»ƒm tra mÃ£ nguá»“n vÃ  kiá»ƒm thá»­ mÃ n hÃ¬nh hiá»ƒn thá»‹ thÃ´ng tin thanh toÃ¡n. Chá»©c nÄƒng che giáº¥u sáº½ Ä‘Æ°á»£c Ã¡p dá»¥ng nháº¥t quÃ¡n trÃªn táº¥t cáº£ giao diá»‡n ngÆ°á»i dÃ¹ng bao gá»“m phiÃªn báº£n di Ä‘á»™ng vÃ  web.

SAF-2: XÃ³a dá»¯ liá»‡u má»m: Há»‡ thá»‘ng sáº½ thá»±c hiá»‡n xÃ³a má»m cho táº¥t cáº£ há»“ sÆ¡ y táº¿ quan trá»ng, Ä‘áº£m báº£o ráº±ng dá»¯ liá»‡u Ä‘Ã£ xÃ³a cÃ³ thá»ƒ Ä‘Æ°á»£c khÃ´i phá»¥c cho má»¥c Ä‘Ã­ch phÃ¡p lÃ½ hoáº·c cáº¥p cá»©u y táº¿ trong vÃ²ng 30 ngÃ y. Äiá»u nÃ y sáº½ Ä‘Æ°á»£c Ä‘o lÆ°á»ng thÃ´ng qua nháº­t kÃ½ kiá»ƒm tra cÆ¡ sá»Ÿ dá»¯ liá»‡u cho tháº¥y cÃ¡c báº£n ghi Ä‘Ã£ xÃ³a váº«n duy trÃ¬ tÃ­nh toÃ n váº¹n dá»¯ liá»‡u trong khi Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u lÃ  khÃ´ng hoáº¡t Ä‘á»™ng. CÆ¡ cháº¿ xÃ³a má»m sáº½ báº£o toÃ n táº¥t cáº£ dá»¯ liá»‡u gá»‘c trong khi ngÄƒn cháº·n truy cáº­p thÃ´ng qua giao diá»‡n ngÆ°á»i dÃ¹ng thÃ´ng thÆ°á»ng.

2.4.2 An toÃ n thanh toÃ¡n vÃ  giao dá»‹ch  
SAF-3: Háº¿t háº¡n thanh toÃ¡n QR: Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng háº¿t háº¡n mÃ£ thanh toÃ¡n QR sau 24 giá» Ä‘á»ƒ ngÄƒn cháº·n viá»‡c sá»­ dá»¥ng trÃ¡i phÃ©p cÃ¡c tham chiáº¿u thanh toÃ¡n cÅ©. Äiá»u nÃ y sáº½ Ä‘Æ°á»£c xÃ¡c minh thÃ´ng qua kiá»ƒm thá»­ tá»± Ä‘á»™ng xÃ¡c nháº­n ráº±ng cÃ¡c mÃ£ QR háº¿t háº¡n bá»‹ tá»« chá»‘i bá»Ÿi há»‡ thá»‘ng thanh toÃ¡n. CÆ¡ cháº¿ háº¿t háº¡n sáº½ bao gá»“m thÃ´ng bÃ¡o rÃµ rÃ ng cho ngÆ°á»i dÃ¹ng vá» thá»i gian hiá»‡u lá»±c cá»§a mÃ£ thanh toÃ¡n.

SAF-4: Báº£o vá»‡ phÆ°Æ¡ng thá»©c thanh toÃ¡n: Há»‡ thá»‘ng sáº½ ngÄƒn cháº·n viá»‡c xÃ³a phÆ°Æ¡ng thá»©c thanh toÃ¡n cuá»‘i cÃ¹ng cÃ²n láº¡i cá»§a báº¥t ká»³ tÃ i khoáº£n ngÆ°á»i dÃ¹ng nÃ o Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh liÃªn tá»¥c cá»§a kháº£ nÄƒng thanh toÃ¡n cho cÃ¡c dá»‹ch vá»¥ y táº¿ kháº©n cáº¥p. Äiá»u nÃ y sáº½ Ä‘Æ°á»£c Ä‘o lÆ°á»ng thÃ´ng qua kiá»ƒm thá»­ giao diá»‡n ngÆ°á»i dÃ¹ng xÃ¡c minh viá»‡c ngÄƒn cháº·n xÃ³a vÃ  thÃ´ng bÃ¡o lá»—i phÃ¹ há»£p. CÆ¡ cháº¿ báº£o vá»‡ sáº½ Ã¡p dá»¥ng cho cáº£ phÆ°Æ¡ng thá»©c thanh toÃ¡n máº·c Ä‘á»‹nh vÃ  khÃ´ng máº·c Ä‘á»‹nh khi chá»‰ cÃ²n má»™t phÆ°Æ¡ng thá»©c.

2.4.3 An toÃ n dá»‹ch vá»¥ y táº¿
SAF-5: An toÃ n láº­p lá»‹ch xÃ©t nghiá»‡m STI: Há»‡ thá»‘ng sáº½ xÃ¡c thá»±c ráº±ng táº¥t cáº£ cÃ¡c cuá»™c háº¹n xÃ©t nghiá»‡m STI Ä‘Æ°á»£c láº­p lá»‹ch vá»›i khoáº£ng thá»i gian phÃ¹ há»£p (thÃ´ng bÃ¡o tá»‘i thiá»ƒu 24 giá») Ä‘á»ƒ cho phÃ©p chuáº©n bá»‹ phÃ²ng thÃ­ nghiá»‡m phÃ¹ há»£p vÃ  ngÄƒn cháº·n lá»—i xÃ©t nghiá»‡m vá»™i vÃ ng. Äiá»u nÃ y sáº½ Ä‘Æ°á»£c xÃ¡c minh thÃ´ng qua kiá»ƒm thá»­ Ä‘áº·t lá»‹ch háº¹n vá»›i cÃ¡c tÃ¬nh huá»‘ng thá»i gian khÃ¡c nhau. Viá»‡c xÃ¡c thá»±c sáº½ bao gá»“m cuá»‘i tuáº§n vÃ  ngÃ y lá»… trong tÃ­nh toÃ¡n Ä‘á»ƒ Ä‘áº£m báº£o thá»i gian chuáº©n bá»‹ Ä‘áº§y Ä‘á»§.

2.4.4 XÃ¡c thá»±c vÃ  kiá»ƒm soÃ¡t truy cáº­p
SAF-6: Äá»™ phá»©c táº¡p máº­t kháº©u: Há»‡ thá»‘ng sáº½ thá»±c thi cÃ¡c yÃªu cáº§u vá» Ä‘á»™ phá»©c táº¡p máº­t kháº©u vá»›i tá»‘i thiá»ƒu 8 kÃ½ tá»± bao gá»“m chá»¯ hoa, chá»¯ thÆ°á»ng, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t nhÆ° Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong xÃ¡c thá»±c RegisterRequest. Äiá»u nÃ y sáº½ Ä‘Æ°á»£c Ä‘o lÆ°á»ng thÃ´ng qua kiá»ƒm thá»­ Ä‘Äƒng kÃ½ vÃ  thay Ä‘á»•i máº­t kháº©u vá»›i cÃ¡c tá»• há»£p máº­t kháº©u khÃ¡c nhau. Viá»‡c thá»±c thi Ä‘á»™ phá»©c táº¡p sáº½ cung cáº¥p pháº£n há»“i rÃµ rÃ ng cho ngÆ°á»i dÃ¹ng vá» cÃ¡c yÃªu cáº§u cá»¥ thá»ƒ khÃ´ng Ä‘Æ°á»£c Ä‘Ã¡p á»©ng.

SAF-7: Kiá»ƒm soÃ¡t truy cáº­p dá»±a trÃªn vai trÃ²: Há»‡ thá»‘ng sáº½ thá»±c hiá»‡n kiá»ƒm soÃ¡t truy cáº­p dá»±a trÃªn vai trÃ² trong Ä‘Ã³ cÃ¡c vai trÃ² ADMIN, STAFF, CONSULTANT vÃ  CUSTOMER cÃ³ quyá»n Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nghiÃªm ngáº·t vÃ  khÃ´ng thá»ƒ truy cáº­p cÃ¡c chá»©c nÄƒng ngoÃ i pháº¡m vi Ä‘Æ°á»£c á»§y quyá»n cá»§a há». Äiá»u nÃ y sáº½ Ä‘Æ°á»£c xÃ¡c minh thÃ´ng qua kiá»ƒm thá»­ báº£o máº­t vá»›i cÃ¡c vai trÃ² ngÆ°á»i dÃ¹ng khÃ¡c nhau cá»‘ gáº¯ng truy cáº­p cÃ¡c chá»©c nÄƒng bá»‹ háº¡n cháº¿. Kiá»ƒm soÃ¡t truy cáº­p sáº½ Ä‘Æ°á»£c thá»±c thi á»Ÿ cáº£ cáº¥p Ä‘á»™ API vÃ  giao diá»‡n ngÆ°á»i dÃ¹ng.

SAF-8: Ghi Ä‘Ã¨ truy cáº­p kháº©n cáº¥p: Há»‡ thá»‘ng sáº½ cung cáº¥p kháº£ nÄƒng ghi Ä‘Ã¨ thá»§ cÃ´ng cho nhÃ¢n viÃªn y táº¿ Ä‘Æ°á»£c á»§y quyá»n Ä‘á»ƒ truy cáº­p há»“ sÆ¡ bá»‡nh nhÃ¢n trong cÃ¡c tÃ¬nh huá»‘ng kháº©n cáº¥p há»‡ thá»‘ng hoáº·c tÃ¬nh huá»‘ng y táº¿ quan trá»ng. Äiá»u nÃ y sáº½ Ä‘Æ°á»£c Ä‘o lÆ°á»ng thÃ´ng qua kiá»ƒm thá»­ tÃ¬nh huá»‘ng kháº©n cáº¥p vÃ  xÃ¡c minh nháº­t kÃ½ kiá»ƒm tra. CÆ¡ cháº¿ ghi Ä‘Ã¨ sáº½ duy trÃ¬ nháº­t kÃ½ chi tiáº¿t cá»§a táº¥t cáº£ cÃ¡c trÆ°á»ng há»£p truy cáº­p kháº©n cáº¥p.

2.4.5 NgÄƒn cháº·n láº¡m dá»¥ng há»‡ thá»‘ng
SAF-9: Báº£o vá»‡ giá»›i háº¡n táº§n suáº¥t: Há»‡ thá»‘ng sáº½ thá»±c hiá»‡n giá»›i háº¡n táº§n suáº¥t cho mÃ£ xÃ¡c minh SMS vÃ  email (tá»‘i Ä‘a 3 láº§n thá»­ má»—i giá») Ä‘á»ƒ ngÄƒn cháº·n láº¡m dá»¥ng spam vÃ  quÃ¡ táº£i há»‡ thá»‘ng. Äiá»u nÃ y sáº½ Ä‘Æ°á»£c xÃ¡c minh thÃ´ng qua kiá»ƒm thá»­ tá»± Ä‘á»™ng cá»‘ gáº¯ng vÆ°á»£t quÃ¡ giá»›i háº¡n táº§n suáº¥t vÃ  xÃ¡c nháº­n hÃ nh vi cháº·n phÃ¹ há»£p. Giá»›i háº¡n táº§n suáº¥t sáº½ bao gá»“m Ä‘á»™ trá»… tiáº¿n triá»ƒn cho cÃ¡c vi pháº¡m láº·p láº¡i.

---

## TÃ³m táº¯t giáº£m thiá»ƒu rá»§i ro

CÃ¡c yÃªu cáº§u an toÃ n Ä‘Ã£ triá»ƒn khai nÃ y giáº£i quyáº¿t cÃ¡c rá»§i ro quan trá»ng sau trong Há»‡ thá»‘ng quáº£n lÃ½ dá»‹ch vá»¥ chÄƒm sÃ³c sá»©c khá»e giá»›i tÃ­nh:

1. **Báº£o vá»‡ dá»¯ liá»‡u tÃ i chÃ­nh** - SAF-1: Che giáº¥u tháº» tÃ­n dá»¥ng ngÄƒn cháº·n viá»‡c lá»™ thÃ´ng tin thanh toÃ¡n nháº¡y cáº£m
2. **Báº£o máº­t thanh toÃ¡n** - SAF-3, SAF-4: Háº¿t háº¡n mÃ£ QR vÃ  báº£o vá»‡ phÆ°Æ¡ng thá»©c thanh toÃ¡n Ä‘áº£m báº£o báº£o máº­t giao dá»‹ch
3. **An toÃ n dá»‹ch vá»¥ y táº¿** - SAF-5: YÃªu cáº§u thÃ´ng bÃ¡o 24 giá» ngÄƒn cháº·n cÃ¡c thá»§ tá»¥c y táº¿ vá»™i vÃ ng
4. **Kiá»ƒm soÃ¡t truy cáº­p** - SAF-6, SAF-7, SAF-8: XÃ¡c thá»±c máº¡nh vÃ  quyá»n dá»±a trÃªn vai trÃ² báº£o vá»‡ truy cáº­p há»‡ thá»‘ng
5. **KhÃ´i phá»¥c dá»¯ liá»‡u** - SAF-2: XÃ³a má»m Ä‘áº£m báº£o dá»¯ liá»‡u cÃ³ thá»ƒ Ä‘Æ°á»£c khÃ´i phá»¥c khi cáº§n
6. **NgÄƒn cháº·n láº¡m dá»¥ng há»‡ thá»‘ng** - SAF-9: Giá»›i háº¡n táº§n suáº¥t ngÄƒn cháº·n spam vÃ  quÃ¡ táº£i há»‡ thá»‘ng

Má»—i yÃªu cáº§u Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c minh thÃ´ng qua triá»ƒn khai mÃ£ nguá»“n vÃ  bao gá»“m cÃ¡c tiÃªu chÃ­ Ä‘o lÆ°á»ng cá»¥ thá»ƒ.

---

## Báº°NG CHá»¨NG MÃƒ NGUá»’N VÃ€ TRáº NG THÃI TRIá»‚N KHAI

### âœ… CÃC TÃNH NÄ‚NG AN TOÃ€N ÄÃƒ TRIá»‚N KHAI Vá»šI Báº°NG CHá»¨NG MÃƒ NGUá»’N

#### SAF-1: Che giáº¥u sá»‘ tháº» tÃ­n dá»¥ng

**Triá»ƒn khai:** Sá»‘ tháº» thanh toÃ¡n Ä‘Æ°á»£c tá»± Ä‘á»™ng che giáº¥u trong táº¥t cáº£ mÃ n hÃ¬nh hiá»ƒn thá»‹ há»‡ thá»‘ng

```java
// File: PaymentInfo.java dÃ²ng 71-77
public String getMaskedCardNumber() {
    if (cardNumber == null || cardNumber.length() < 4) {
        return "****";
    }
    return "**** **** **** " + cardNumber.substring(cardNumber.length() - 4);
}
```

#### SAF-3: Háº¿t háº¡n thanh toÃ¡n QR

**Triá»ƒn khai:** MÃ£ thanh toÃ¡n QR tá»± Ä‘á»™ng háº¿t háº¡n sau 24 giá»

```java
// File: PaymentService.java dÃ²ng 181
payment.setExpiresAt(LocalDateTime.now().plusHours(24)); // QR cÃ³ hiá»‡u lá»±c 24h
```

```properties
# File: application-cloud.properties dÃ²ng 50
qr.payment.expiry.hours=${QR_PAYMENT_EXPIRY_HOURS:24}
```

#### SAF-4: NgÄƒn cháº·n xÃ³a phÆ°Æ¡ng thá»©c thanh toÃ¡n cuá»‘i cÃ¹ng

**Triá»ƒn khai:** Há»‡ thá»‘ng ngÄƒn cháº·n viá»‡c xÃ³a phÆ°Æ¡ng thá»©c thanh toÃ¡n duy nháº¥t cÃ²n láº¡i

```java
// File: PaymentInfoService.java dÃ²ng 210-215
if (Boolean.TRUE.equals(card.getIsDefault())) {
    long cardCount = paymentInfoRepository.countByUserIdAndIsActiveTrue(userId);
    if (cardCount <= 1) {
        return ApiResponse.error("Cannot delete the only payment method");
    }
}
```

#### SAF-5: ThÃ´ng bÃ¡o 24 giá» cho xÃ©t nghiá»‡m STI

**Triá»ƒn khai:** Há»‡ thá»‘ng thá»±c thi thÃ´ng bÃ¡o trÆ°á»›c 24 giá» cho cÃ¡c cuá»™c háº¹n xÃ©t nghiá»‡m STI

```java
// File: STITestService.java dÃ²ng 1007-1008
if (stiTest.getAppointmentDate().isBefore(LocalDateTime.now().plusHours(24))) {
    return ApiResponse.error("Cannot cancel test within 24 hours of appointment");
}
```

#### SAF-6: YÃªu cáº§u Ä‘á»™ phá»©c táº¡p máº­t kháº©u

**Triá»ƒn khai:** XÃ¡c thá»±c máº­t kháº©u máº¡nh vá»›i cÃ¡c máº«u regex

```java
// File: RegisterRequest.java dÃ²ng 17-18
@Pattern(regexp = "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=]).*$",
         message = "Password must contain at least 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character")
```

```java
// File: ChangePasswordRequest.java dÃ²ng 17-20
@Pattern(regexp = "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=]).*$",
         message = "New password must contain at least 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character")
```

#### SAF-7: Kiá»ƒm soÃ¡t truy cáº­p dá»±a trÃªn vai trÃ²

**Triá»ƒn khai:** Cáº¥u hÃ¬nh báº£o máº­t dá»±a trÃªn vai trÃ² toÃ n diá»‡n

```java
// File: SecurityConfig.java - VÃ­ dá»¥ háº¡n cháº¿ vai trÃ²
.requestMatchers(HttpMethod.GET, "/admin/users").hasRole("ADMIN")
.requestMatchers(HttpMethod.POST, "/sti-services").hasRole("STAFF")
.requestMatchers(HttpMethod.PUT, "/consultants/profile/{userId}").hasRole("CONSULTANT")
.requestMatchers(HttpMethod.GET, "/sti-services/my-tests").authenticated()
```

#### SAF-2: Triá»ƒn khai xÃ³a má»m

**Triá»ƒn khai:** Dá»¯ liá»‡u quan trá»ng sá»­ dá»¥ng xÃ³a má»m cho má»¥c Ä‘Ã­ch khÃ´i phá»¥c

```java
// File: PaymentInfoService.java dÃ²ng 238
card.setIsActive(false);  // XÃ³a má»m thay vÃ¬ xÃ³a cá»©ng
```

```java
// File: UserDtls.java dÃ²ng 77-81
@Column(name = "is_deleted", nullable = false, columnDefinition = "BIT DEFAULT 0")
private Boolean isDeleted = false;
@Column(name = "deleted_at")
private LocalDateTime deletedAt;
```

#### SAF-9: Giá»›i háº¡n táº§n suáº¥t cho mÃ£ xÃ¡c minh

**Triá»ƒn khai:** NgÄƒn cháº·n láº¡m dá»¥ng spam thÃ´ng qua cÆ¡ cháº¿ giá»›i háº¡n táº§n suáº¥t

```java
// File: PhoneVerificationService.java dÃ²ng 44-45
if (isRateLimited(formattedPhone)) {
    throw new RateLimitException("Please wait " + rateLimitMinutes + " minute(s) before requesting new code");
}
```

```java
// File: PasswordResetService.java dÃ²ng 30-35
if (secondsElapsed < COOLDOWN_SECONDS) {
    throw new RateLimitException("Please wait " + (COOLDOWN_SECONDS - secondsElapsed) +
            " seconds before requesting another code");
}
```

#### SAF-8: Ghi Ä‘Ã¨ truy cáº­p kháº©n cáº¥p

**Triá»ƒn khai:** Kháº£ nÄƒng ghi Ä‘Ã¨ quáº£n trá»‹ cho cÃ¡c tÃ¬nh huá»‘ng kháº©n cáº¥p

```java
// File: SecurityConfig.java - Truy cáº­p kháº©n cáº¥p cá»§a Admin
.requestMatchers(HttpMethod.GET, "/admin/users/{userId}").hasRole("ADMIN")
.requestMatchers(HttpMethod.PUT, "/admin/users/{userId}").hasRole("ADMIN")
```

---

## ğŸ“Š TÃ“M Táº®T TRIá»‚N KHAI

**Tá»•ng sá»‘ yÃªu cáº§u an toÃ n Ä‘Ã£ triá»ƒn khai:** 9 trÃªn 9 yÃªu cáº§u Ä‘Æ°á»£c tÃ i liá»‡u hÃ³a (100%)

**CÃ¡c lÄ©nh vá»±c bao phá»§:**

- âœ… Báº£o vá»‡ dá»¯ liá»‡u tÃ i chÃ­nh
- âœ… Báº£o máº­t thanh toÃ¡n
- âœ… An toÃ n dá»‹ch vá»¥ y táº¿
- âœ… XÃ¡c thá»±c ngÆ°á»i dÃ¹ng
- âœ… Kiá»ƒm soÃ¡t truy cáº­p
- âœ… KhÃ´i phá»¥c dá»¯ liá»‡u
- âœ… Giá»›i háº¡n táº§n suáº¥t
- âœ… Truy cáº­p kháº©n cáº¥p

**TiÃªu chuáº©n báº£o máº­t Ä‘Ã£ Ä‘Ã¡p á»©ng:**

- Thá»±c thi Ä‘á»™ phá»©c táº¡p máº­t kháº©u
- Kiá»ƒm soÃ¡t truy cáº­p dá»±a trÃªn vai trÃ² (RBAC)
- XÃ³a má»m Ä‘á»ƒ khÃ´i phá»¥c dá»¯ liá»‡u
- Giá»›i háº¡n táº§n suáº¥t Ä‘á»ƒ ngÄƒn cháº·n láº¡m dá»¥ng
- Che giáº¥u dá»¯ liá»‡u tÃ i chÃ­nh
- Báº£o vá»‡ phÆ°Æ¡ng thá»©c thanh toÃ¡n

TÃ i liá»‡u nÃ y phá»¥c vá»¥ nhÆ° báº±ng chá»©ng ráº±ng Há»‡ thá»‘ng quáº£n lÃ½ dá»‹ch vá»¥ chÄƒm sÃ³c sá»©c khá»e giá»›i tÃ­nh Ä‘Ã£ triá»ƒn khai cÃ¡c biá»‡n phÃ¡p an toÃ n quan trá»ng vá»›i cÃ¡c triá»ƒn khai mÃ£ nguá»“n cÃ³ thá»ƒ xÃ¡c minh Ä‘á»ƒ báº£o vá»‡ dá»¯ liá»‡u bá»‡nh nhÃ¢n, thÃ´ng tin tÃ i chÃ­nh vÃ  Ä‘áº£m báº£o hoáº¡t Ä‘á»™ng há»‡ thá»‘ng an toÃ n.
